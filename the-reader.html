<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="The Reader">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<title>The Reader</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Lora:ital,wght@0,400;0,500;1,400&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Literata:ital,opsz,wght@0,7..72,400;0,7..72,500;1,7..72,400&family=Merriweather:ital,wght@0,400;0,700;1,400&family=EB+Garamond:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#F5EDE0;--paper:#FAF6EE;--ink:#2C2416;--muted:#7A6E5D;--rule:#D4C9B8;
  --accent:#8B7355;--highlight:rgba(218,185,107,.35);
  --filter:sepia(25%) saturate(85%) brightness(95%) contrast(92%);
  --safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px);
  --body-font:'Lora',serif;
}
[data-theme="newspaper"]{
  --bg:#E8E0D0;--paper:#F0E8D8;--ink:#1A1A1A;--muted:#555544;--rule:#C4B8A4;
  --accent:#6B5B3E;--highlight:rgba(200,170,80,.4);
  --filter:sepia(15%) saturate(70%) brightness(92%) contrast(105%);
}
[data-theme="cream"]{
  --bg:#FFF8EC;--paper:#FFFCF5;--ink:#3C3428;--muted:#8C8070;--rule:#E0D8C8;
  --accent:#A08860;--highlight:rgba(230,200,120,.3);
  --filter:sepia(10%) saturate(90%) brightness(98%) contrast(90%);
}
[data-theme="dark"]{
  --bg:#1C1915;--paper:#2A2520;--ink:#D4C8B0;--muted:#8A7E6C;--rule:#3D3630;
  --accent:#B09870;--highlight:rgba(180,150,80,.3);
  --filter:sepia(10%) brightness(90%) contrast(95%);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:var(--body-font);background:var(--bg);color:var(--ink);
  width:100vw;height:100vh;height:100dvh;overflow:hidden;display:flex;flex-direction:column}
::selection{background:var(--highlight)}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--rule);border-radius:2px}

/* ─── SPLASH ─── */
#splash{flex:1;display:flex;align-items:center;justify-content:center;padding:24px;
  background:linear-gradient(170deg,#F5EDE0 0%,#FFF8EC 50%,#E8E0D0 100%);animation:fadeUp .5s ease}
#splash.hidden{display:none}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.splash-inner{max-width:520px;width:100%;text-align:center}
.mh{border-top:3px double var(--ink);border-bottom:1px solid var(--rule);padding:20px 0 16px;margin-bottom:28px}
.mh-sub{font-family:'Cormorant Garamond',serif;font-size:11px;text-transform:uppercase;letter-spacing:.35em;color:var(--muted);margin-bottom:8px}
.mh h1{font-family:'Playfair Display',serif;font-size:44px;font-weight:400;font-style:italic;line-height:1.1;margin-bottom:6px}
.mh-tag{font-family:'Cormorant Garamond',serif;font-size:12px;text-transform:uppercase;letter-spacing:.25em;color:var(--muted)}
.orn{display:flex;align-items:center;gap:12px;max-width:260px;margin:0 auto 26px}
.orn-l{flex:1;height:1px;background:var(--rule)}.orn-d{font-size:13px;color:var(--accent)}
.dz{border:2px dashed var(--rule);border-radius:4px;padding:48px 28px;cursor:pointer;
  transition:all .3s ease;background:rgba(255,255,255,.2)}
.dz:active,.dz.over{border-color:var(--accent);background:rgba(255,255,255,.45)}
.dz-i{font-size:48px;margin-bottom:14px;opacity:.5}
.dz-t{font-family:'Playfair Display',serif;font-size:18px;font-style:italic;margin-bottom:6px}
.dz-h{font-size:13px;color:var(--muted)}
/* Library */
.lib{margin-top:28px;border-top:1px solid var(--rule);padding-top:20px}
.lib-title{font-family:'Cormorant Garamond',serif;font-size:11px;text-transform:uppercase;
  letter-spacing:.3em;color:var(--muted);margin-bottom:14px}
.lib-grid{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
.lib-item{background:var(--paper);border:1px solid var(--rule);border-radius:4px;
  padding:12px 16px;cursor:pointer;max-width:200px;text-align:left;transition:all .2s;position:relative}
.lib-item:active{background:var(--rule)}
.lib-item-name{font-size:13px;font-weight:500;margin-bottom:2px;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:150px}
.lib-item-info{font-size:11px;color:var(--muted);font-style:italic}
.lib-item-del{position:absolute;top:4px;right:6px;background:none;border:none;
  font-size:16px;color:var(--muted);cursor:pointer;padding:2px 4px;line-height:1}
#errorMsg{display:none;margin-top:16px;padding:12px 16px;background:rgba(180,80,60,.08);
  border:1px solid rgba(180,80,60,.25);border-radius:4px;font-size:13px;color:#8B4033;font-style:italic}
#errorMsg.visible{display:block}
.splash-ft{margin-top:24px;font-size:12px;color:var(--muted);line-height:1.8;font-style:italic}

/* ─── LOADING ─── */
#loadScr{display:none;flex:1;align-items:center;justify-content:center;flex-direction:column;gap:16px;background:var(--bg)}
#loadScr.active{display:flex}
.ld-t{font-family:'Playfair Display',serif;font-size:22px;font-style:italic}
.prog-t{width:220px;height:2px;background:var(--rule);border-radius:1px;overflow:hidden}
.prog-f{height:100%;width:0%;background:var(--accent);transition:width .3s ease}
.ld-d{font-size:12px;color:var(--muted);font-style:italic}

/* ─── READER ─── */
#reader{display:none;flex-direction:column;flex:1;overflow:hidden;position:relative}
#reader.active{display:flex}

/* Top bar */
.topbar{display:flex;align-items:center;justify-content:space-between;
  padding:8px 14px;padding-top:calc(8px + var(--safe-top));
  background:var(--paper);border-bottom:1px solid var(--rule);flex-shrink:0;
  transition:transform .3s ease;z-index:20}
.topbar.hide{transform:translateY(-100%)}
.tb-left{display:flex;align-items:center;gap:10px}
.tb-right{display:flex;align-items:center;gap:6px}
.ib{background:none;border:none;font-size:18px;padding:6px 8px;cursor:pointer;color:var(--ink);
  border-radius:4px;display:flex;align-items:center;justify-content:center;transition:background .15s}
.ib:active{background:var(--rule)}
.ib.on{background:var(--accent);color:var(--paper)}
.fn{font-size:12px;color:var(--muted);max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tb-brand{font-family:'Playfair Display',serif;font-style:italic;font-size:16px;
  position:absolute;left:50%;transform:translateX(-50%);color:var(--ink);pointer-events:none}

/* Bottom bar */
.botbar{display:flex;align-items:center;justify-content:center;gap:8px;
  padding:8px 14px;padding-bottom:calc(8px + var(--safe-bottom));
  background:var(--paper);border-top:1px solid var(--rule);flex-shrink:0;
  transition:transform .3s ease;z-index:20}
.botbar.hide{transform:translateY(100%)}
.bb-pg{font-size:12px;color:var(--muted);min-width:60px;text-align:center}
.bb-sep{width:1px;height:18px;background:var(--rule)}
.bb-btn{background:none;border:1px solid var(--rule);border-radius:3px;
  padding:4px 10px;font-family:inherit;font-size:12px;color:var(--ink);cursor:pointer}
.bb-btn:active{background:var(--rule)}
.bb-btn:disabled{color:var(--rule)}
.bb-btn.on{background:var(--accent);color:var(--paper);border-color:var(--accent)}
.bb-zoom{font-size:11px;color:var(--muted);min-width:40px;text-align:center}

/* Panels */
.panel{position:absolute;top:0;left:0;width:280px;height:100%;background:var(--paper);
  border-right:1px solid var(--rule);z-index:30;transform:translateX(-100%);
  transition:transform .3s ease;display:flex;flex-direction:column;overflow:hidden}
.panel.open{transform:translateX(0)}
.panel-head{padding:14px;border-bottom:1px solid var(--rule);display:flex;
  align-items:center;justify-content:space-between}
.panel-title{font-family:'Playfair Display',serif;font-size:15px;font-style:italic}
.panel-body{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:10px}
.backdrop{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.3);
  z-index:25;display:none}
.backdrop.show{display:block}

/* Thumbnails */
.thumb{display:flex;align-items:center;gap:10px;padding:8px;cursor:pointer;
  border-radius:4px;transition:background .15s;margin-bottom:4px}
.thumb:active,.thumb.cur{background:var(--rule)}
.thumb canvas{border:1px solid var(--rule);border-radius:2px;flex-shrink:0}
.thumb-n{font-size:12px;color:var(--muted)}

/* Settings panel */
.sett-section{margin-bottom:18px}
.sett-label{font-size:11px;text-transform:uppercase;letter-spacing:.15em;
  color:var(--muted);margin-bottom:8px;font-family:'Cormorant Garamond',serif}
.sett-row{display:flex;gap:6px;flex-wrap:wrap}
.sett-btn{background:none;border:1px solid var(--rule);border-radius:3px;
  padding:5px 10px;font-size:11px;cursor:pointer;color:var(--ink);font-family:inherit;transition:all .15s}
.sett-btn:active{background:var(--rule)}
.sett-btn.on{background:var(--accent);color:var(--paper);border-color:var(--accent)}

/* Search bar */
.srch{display:none;align-items:center;gap:6px;padding:8px 14px;
  background:var(--paper);border-bottom:1px solid var(--rule);flex-shrink:0;z-index:20}
.srch.open{display:flex}
.srch input{flex:1;border:1px solid var(--rule);border-radius:3px;padding:6px 10px;
  font-family:inherit;font-size:13px;background:var(--bg);color:var(--ink);outline:none}
.srch input:focus{border-color:var(--accent)}
.srch-info{font-size:11px;color:var(--muted);min-width:50px;text-align:center}

/* Pages */
#pages{flex:1;overflow:auto;-webkit-overflow-scrolling:touch;
  padding:20px;padding-bottom:calc(20px + var(--safe-bottom));
  display:flex;flex-direction:column;align-items:center;gap:24px;scroll-behavior:smooth}
#pages.single{scroll-snap-type:y mandatory;gap:0;padding:0}
.pg{position:relative;flex-shrink:0;box-shadow:0 1px 16px rgba(44,36,22,.08),0 0 0 1px var(--rule);
  background:var(--paper);border-radius:2px}
#pages.single .pg{scroll-snap-align:center;min-height:100%;display:flex;
  flex-direction:column;align-items:center;justify-content:center;padding:20px;
  box-shadow:none;background:var(--bg);border-radius:0}
.pg canvas{display:block;filter:var(--filter);border-radius:2px}
#pages.single .pg canvas{box-shadow:0 1px 16px rgba(44,36,22,.08),0 0 0 1px var(--rule)}
.pg-n{text-align:center;font-size:10px;color:var(--muted);font-style:italic;
  letter-spacing:.1em;margin-top:8px;font-family:'Cormorant Garamond',serif}
.pg .hl-layer,.pg .sr-layer{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
#pages.single .pg .hl-layer,#pages.single .pg .sr-layer{
  position:absolute;pointer-events:none}
.hl-rect{position:absolute;border-radius:2px;mix-blend-mode:multiply}
.sr-rect{position:absolute;border-radius:2px;background:rgba(255,140,0,.3);mix-blend-mode:multiply}
.sr-rect.cur{background:rgba(255,100,0,.55);outline:2px solid rgba(255,100,0,.6)}

/* Selection popup */
.sel-popup{position:fixed;z-index:50;background:var(--paper);border:1px solid var(--rule);
  border-radius:6px;box-shadow:0 4px 20px rgba(0,0,0,.15);padding:4px;
  display:none;gap:2px}
.sel-popup.show{display:flex}
.sel-btn{background:none;border:none;padding:6px 10px;font-family:inherit;font-size:12px;
  color:var(--ink);cursor:pointer;border-radius:4px;white-space:nowrap}
.sel-btn:active{background:var(--rule)}

/* Toggle bars button */
.tog{position:fixed;bottom:50%;right:0;z-index:15;background:var(--paper);
  border:1px solid var(--rule);border-right:none;border-radius:6px 0 0 6px;
  padding:8px 4px;cursor:pointer;opacity:.5;transition:opacity .2s}
.tog:active{opacity:1}

.spacer{height:40px;flex-shrink:0}
@media(max-width:768px){.mh h1{font-size:34px}.tb-brand{display:none}.panel{width:240px}}
</style>
</head>
<body data-theme="sepia">

<!-- SPLASH -->
<div id="splash">
<div class="splash-inner">
  <div class="mh"><div class="mh-sub">Est. 2025 — iPad Edition</div>
    <h1>The Reader</h1><div class="mh-tag">A Gentler Way to Read</div></div>
  <div class="orn"><div class="orn-l"></div><div class="orn-d">&#10022;</div><div class="orn-l"></div></div>
  <div class="dz" id="dropZone"><div class="dz-i">&#128196;</div>
    <div class="dz-t">Drop a PDF here</div><div class="dz-h">or tap to browse</div></div>
  <input type="file" id="fileInput" accept="application/pdf,.pdf" style="display:none">
  <div id="errorMsg"></div>
  <div class="lib" id="library" style="display:none">
    <div class="lib-title">Your Library</div>
    <div class="lib-grid" id="libGrid"></div>
  </div>
  <div class="splash-ft">Stores PDFs locally · Highlights · Search · Define · Thumbnails · Fullscreen</div>
</div></div>

<!-- LOADING -->
<div id="loadScr">
  <div class="ld-t">Preparing&#8230;</div>
  <div class="prog-t"><div class="prog-f" id="progBar"></div></div>
  <div class="ld-d" id="loadMsg">0%</div>
</div>

<!-- READER -->
<div id="reader">
  <!-- Top bar -->
  <div class="topbar" id="topbar">
    <div class="tb-left">
      <button class="ib" id="btnBack" title="Library">&#9664;</button>
      <button class="ib" id="btnThumbs" title="Pages">&#9776;</button>
      <span class="fn" id="fileLabel"></span>
    </div>
    <div class="tb-brand">The Reader</div>
    <div class="tb-right">
      <button class="ib" id="btnSearch" title="Search">&#128269;</button>
      <button class="ib" id="btnSettings" title="Settings">&#9881;</button>
      <button class="ib" id="btnFS" title="Fullscreen">&#9974;</button>
    </div>
  </div>

  <!-- Search -->
  <div class="srch" id="searchBar">
    <input id="srchIn" type="text" placeholder="Search&#8230;">
    <span class="srch-info" id="srchInfo"></span>
    <button class="bb-btn" id="srchPrev">&#8249;</button>
    <button class="bb-btn" id="srchNext">&#8250;</button>
    <button class="ib" id="srchClose" style="font-size:14px">&#10005;</button>
  </div>

  <!-- Thumbnail panel -->
  <div class="panel" id="thumbPanel">
    <div class="panel-head"><span class="panel-title">Pages</span>
      <button class="ib" id="thumbClose" style="font-size:14px">&#10005;</button></div>
    <div class="panel-body" id="thumbList"></div>
  </div>

  <!-- Settings panel -->
  <div class="panel" id="settPanel" style="left:auto;right:0;border-right:none;border-left:1px solid var(--rule);
    transform:translateX(100%)">
    <div class="panel-head"><span class="panel-title">Settings</span>
      <button class="ib" id="settClose" style="font-size:14px">&#10005;</button></div>
    <div class="panel-body" id="settBody">
      <div class="sett-section"><div class="sett-label">Theme</div><div class="sett-row" id="themeRow"></div></div>
      <div class="sett-section"><div class="sett-label">Font</div><div class="sett-row" id="fontRow"></div></div>
      <div class="sett-section"><div class="sett-label">View</div><div class="sett-row">
        <button class="sett-btn on" id="vScroll">Scroll</button>
        <button class="sett-btn" id="vSingle">Single Page</button>
      </div></div>
    </div>
  </div>

  <div class="backdrop" id="backdrop"></div>

  <!-- Pages -->
  <div id="pages"></div>

  <!-- Bottom bar -->
  <div class="botbar" id="botbar">
    <button class="bb-btn" id="btnPrev">&#8249;</button>
    <span class="bb-pg" id="pgLabel">1 / 1</span>
    <button class="bb-btn" id="btnNext">&#8250;</button>
    <div class="bb-sep"></div>
    <button class="bb-btn" id="btnZO">&#8722;</button>
    <span class="bb-zoom" id="zoomLbl">100%</span>
    <button class="bb-btn" id="btnZI">+</button>
    <span class="bb-pg" id="hlCount"></span>
  </div>

  <!-- Tap to show bars -->
  <button class="tog" id="togBars">&#9654;</button>
</div>

<!-- Password dialog -->
<div id="pwOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:60;
  align-items:center;justify-content:center">
  <div style="background:var(--paper);border:1px solid var(--rule);border-radius:8px;padding:24px;
    max-width:340px;width:90%;text-align:center">
    <div style="font-family:'Playfair Display',serif;font-size:18px;font-style:italic;margin-bottom:12px">
      Password Required</div>
    <div style="font-size:13px;color:var(--muted);margin-bottom:16px">This PDF is password-protected.</div>
    <input id="pwInput" type="password" placeholder="Enter password"
      style="width:100%;padding:8px 12px;border:1px solid var(--rule);border-radius:4px;
      font-family:inherit;font-size:14px;background:var(--bg);color:var(--ink);outline:none;margin-bottom:12px">
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="pwCancel" class="bb-btn" style="padding:8px 20px">Cancel</button>
      <button id="pwSubmit" class="bb-btn on" style="padding:8px 20px;background:var(--accent);
        color:var(--paper);border-color:var(--accent)">Open</button>
    </div>
    <div id="pwErr" style="display:none;margin-top:10px;font-size:12px;color:#8B4033;font-style:italic"></div>
  </div>
</div>

<!-- Selection popup -->
<div class="sel-popup" id="selPopup">
  <button class="sel-btn" id="selHL">&#128230; Highlight</button>
  <button class="sel-btn" id="selDef">&#128214; Define</button>
  <button class="sel-btn" id="selCopy">&#128203; Copy</button>
</div>

<script>
(function(){
'use strict';
function $(id){return document.getElementById(id)}

/* ═══ STATE ═══ */
var pdf=null,nPages=0,curPg=1,scale=1,viewMode='scroll',curTheme='sepia',
    curFont='Lora',barsVis=true,hlStore={},canvases={},wraps={},rendered={},
    dims={},texts={},srRes=[],srIdx=-1,userHL=[],libDB=null,
    DPR=Math.min(window.devicePixelRatio||2,2),renderQ={},renderT=null;

/* ═══ INDEXEDDB ═══ */
function openDB(cb){
  if(libDB){cb(libDB);return}
  var req=indexedDB.open('TheReaderLib',1);
  req.onupgradeneeded=function(e){
    var db=e.target.result;
    if(!db.objectStoreNames.contains('pdfs')) db.createObjectStore('pdfs',{keyPath:'id'});
    if(!db.objectStoreNames.contains('highlights')) db.createObjectStore('highlights',{keyPath:'id'});
  };
  req.onsuccess=function(e){libDB=e.target.result;cb(libDB);};
  req.onerror=function(){cb(null);};
}
function savePDF(name,buf,nP,cb){
  openDB(function(db){
    if(!db){if(cb)cb();return}
    var tx=db.transaction('pdfs','readwrite');
    var id=name+'_'+buf.byteLength;
    tx.objectStore('pdfs').put({id:id,name:name,data:buf,pages:nP,saved:Date.now()});
    tx.oncomplete=function(){if(cb)cb()};
    tx.onerror=function(){if(cb)cb()};
  });
}
function loadLibrary(cb){
  openDB(function(db){
    if(!db){cb([]);return}
    var tx=db.transaction('pdfs','readonly');
    var req=tx.objectStore('pdfs').getAll();
    req.onsuccess=function(){cb(req.result||[])};
    req.onerror=function(){cb([])};
  });
}
function deletePDF(id,cb){
  openDB(function(db){
    if(!db){if(cb)cb();return}
    var tx=db.transaction('pdfs','readwrite');
    tx.objectStore('pdfs').delete(id);
    tx.oncomplete=function(){if(cb)cb()};
  });
}
function saveUserHL(cb){
  openDB(function(db){
    if(!db)return;
    var tx=db.transaction('highlights','readwrite');
    var id=currentFileId();
    tx.objectStore('highlights').put({id:id,data:userHL});
    if(cb) tx.oncomplete=cb;
  });
}
function loadUserHL(cb){
  openDB(function(db){
    if(!db){cb([]);return}
    var tx=db.transaction('highlights','readonly');
    var req=tx.objectStore('highlights').get(currentFileId());
    req.onsuccess=function(){cb(req.result?req.result.data:[])};
    req.onerror=function(){cb([])};
  });
}
var _curFileId='';
function currentFileId(){return _curFileId}

/* ═══ LIBRARY UI ═══ */
function refreshLibrary(){
  loadLibrary(function(items){
    var lib=$('library'),grid=$('libGrid');
    if(!items.length){lib.style.display='none';return}
    lib.style.display='';
    grid.innerHTML='';
    items.sort(function(a,b){return(b.saved||0)-(a.saved||0)});
    items.forEach(function(it){
      var d=document.createElement('div');d.className='lib-item';
      d.innerHTML='<div class="lib-item-name">'+esc(it.name)+'</div>'+
        '<div class="lib-item-info">'+(it.pages||'?')+' pages</div>'+
        '<button class="lib-item-del" title="Remove">&times;</button>';
      d.querySelector('.lib-item-del').addEventListener('click',function(e){
        e.stopPropagation();
        deletePDF(it.id,refreshLibrary);
      });
      d.addEventListener('click',function(){openFromLib(it)});
      grid.appendChild(d);
    });
  });
}
function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML}

function openFromLib(item){
  _curFileId=item.id;
  initPDF(item.data,item.name,true);
}

/* ═══ THEMES + FONTS ═══ */
var themes=[{k:'sepia',l:'Sepia'},{k:'newspaper',l:'News'},{k:'cream',l:'Cream'},{k:'dark',l:'Dark'}];
var fonts=[
  {k:'Lora',l:'Lora'},{k:'Literata',l:'Literata'},{k:'Merriweather',l:'Merriweather'},
  {k:'EB Garamond',l:'Garamond'},{k:'Georgia',l:'Georgia'}
];
themes.forEach(function(t){
  var b=document.createElement('button');b.className='sett-btn'+(t.k===curTheme?' on':'');
  b.textContent=t.l;b.dataset.v=t.k;
  b.addEventListener('click',function(){setTheme(t.k)});
  $('themeRow').appendChild(b);
});
fonts.forEach(function(f){
  var b=document.createElement('button');b.className='sett-btn'+(f.k===curFont?' on':'');
  b.textContent=f.l;b.dataset.v=f.k;b.style.fontFamily="'"+f.k+"',serif";
  b.addEventListener('click',function(){setFont(f.k)});
  $('fontRow').appendChild(b);
});
function setTheme(k){
  curTheme=k;document.body.dataset.theme=k;
  each($('themeRow'),'.sett-btn',function(b){b.classList.toggle('on',b.dataset.v===k)});
}
function setFont(k){
  curFont=k;document.documentElement.style.setProperty('--body-font',"'"+k+"',serif");
  each($('fontRow'),'.sett-btn',function(b){b.classList.toggle('on',b.dataset.v===k)});
}
function each(p,sel,fn){var els=p.querySelectorAll(sel);for(var i=0;i<els.length;i++)fn(els[i])}

/* ═══ SCREENS ═══ */
function showSplash(){$('splash').classList.remove('hidden');$('loadScr').classList.remove('active');
  $('reader').classList.remove('active');refreshLibrary()}
function showLoad(){$('splash').classList.add('hidden');$('loadScr').classList.add('active');$('reader').classList.remove('active')}
function showReader(){$('splash').classList.add('hidden');$('loadScr').classList.remove('active');$('reader').classList.add('active')}
function showErr(m){$('errorMsg').textContent=m;$('errorMsg').classList.add('visible');
  setTimeout(function(){$('errorMsg').classList.remove('visible')},5000)}

/* ═══ FILE INPUT ═══ */
$('dropZone').addEventListener('click',function(e){e.stopPropagation();$('fileInput').click()});
$('fileInput').addEventListener('change',function(e){var f=e.target.files&&e.target.files[0];if(f)pickFile(f)});
$('dropZone').addEventListener('dragover',function(e){e.preventDefault();$('dropZone').classList.add('over')});
$('dropZone').addEventListener('dragleave',function(){$('dropZone').classList.remove('over')});
$('dropZone').addEventListener('drop',function(e){e.preventDefault();$('dropZone').classList.remove('over');
  var f=e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files[0];if(f)pickFile(f)});

function pickFile(f){
  if(f.type!=='application/pdf'&&!f.name.toLowerCase().endsWith('.pdf')){showErr('Select a PDF.');return}
  var fr=new FileReader();
  fr.onload=function(ev){
    var buf=ev.target.result;
    _curFileId=f.name+'_'+buf.byteLength;
    initPDF(buf,f.name,false);
  };
  fr.onerror=function(){showErr('Could not read file.')};
  fr.readAsArrayBuffer(f);
}

/* ═══ PDF.JS ═══ */
var _pdfReady=false,PDFCDN='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js',
    WCDN='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
function ensurePdf(cb){
  if(_pdfReady&&window.pdfjsLib){cb();return}
  if(window.pdfjsLib){setupW(cb);return}
  $('loadMsg').textContent='Loading engine\u2026';
  var s=document.createElement('script');s.src=PDFCDN;
  s.onload=function(){setupW(cb)};
  s.onerror=function(){showSplash();showErr('Could not load PDF engine.')};
  document.head.appendChild(s);
}
function setupW(cb){
  fetch(WCDN).then(function(r){return r.blob()}).then(function(b){
    window.pdfjsLib.GlobalWorkerOptions.workerSrc=URL.createObjectURL(b);
    _pdfReady=true;cb();
  })['catch'](function(){
    window.pdfjsLib.GlobalWorkerOptions.workerSrc='';_pdfReady=true;cb();
  });
}

/* ═══ INIT PDF ═══ */
var _pendingBuf=null,_pendingName='',_pendingFromLib=false;

function initPDF(buf,name,fromLib,password){
  showLoad();$('progBar').style.width='0%';
  $('fileLabel').textContent=name;
  hlStore={};canvases={};wraps={};rendered={};dims={};texts={};
  srRes=[];srIdx=-1;userHL=[];renderQ={};
  _pendingBuf=buf;_pendingName=name;_pendingFromLib=fromLib;

  ensurePdf(function(){
    $('loadMsg').textContent='Opening\u2026';
    // Convert to Uint8Array for reliability (ArrayBuffer can get detached from IndexedDB)
    var data;
    try { data=new Uint8Array(buf); }
    catch(e){ showSplash();showErr('File buffer error: '+e.message);return; }

    var params={data:data};
    if(password) params.password=password;

    var task=window.pdfjsLib.getDocument(params);
    task.onProgress=function(p){if(p.total)$('progBar').style.width=Math.round(p.loaded/p.total*100)+'%'};
    task.promise.then(function(doc){
      $('pwOverlay').style.display='none';
      pdf=doc;nPages=doc.numPages;curPg=1;
      if(!fromLib) savePDF(name,buf,nPages);
      $('loadMsg').textContent='Measuring\u2026';
      var chain=Promise.resolve();
      for(var i=1;i<=nPages;i++)(function(n){
        chain=chain.then(function(){return doc.getPage(n)}).then(function(pg){
          var vp=pg.getViewport({scale:1});dims[n]={w:vp.width,h:vp.height};
        });
      })(i);
      chain.then(function(){
        loadUserHL(function(saved){
          userHL=saved||[];
          buildSlots();buildThumbs();
          updatePg();updateZoom();updateHl();
          showReader();applyVM();
          setTimeout(renderVis,50);
        });
      });
    })['catch'](function(err){
      console.error('PDF open error:',err);
      // Check if password needed
      if(err&&err.name==='PasswordException'){
        showSplash();
        $('pwOverlay').style.display='flex';
        $('pwInput').value='';
        $('pwErr').style.display='none';
        setTimeout(function(){$('pwInput').focus()},100);
        return;
      }
      showSplash();
      var msg='Could not open PDF.';
      if(err&&err.message){
        if(err.message.indexOf('Invalid')!==-1) msg='Invalid or corrupted PDF file.';
        else if(err.message.indexOf('password')!==-1) msg='This PDF requires a password.';
        else msg+=' ('+err.message+')';
      }
      showErr(msg);
    });
  });
}

// Password dialog handlers
$('pwSubmit').addEventListener('click',function(){
  var pw=$('pwInput').value;
  if(!pw){$('pwErr').textContent='Enter a password.';$('pwErr').style.display='block';return}
  $('pwOverlay').style.display='none';
  initPDF(_pendingBuf,_pendingName,_pendingFromLib,pw);
});
$('pwCancel').addEventListener('click',function(){$('pwOverlay').style.display='none';showSplash()});
$('pwInput').addEventListener('keydown',function(e){
  if(e.key==='Enter'){e.preventDefault();$('pwSubmit').click()}
});

/* ═══ BUILD PAGE SLOTS ═══ */
function buildSlots(){
  var p=$('pages');p.innerHTML='';
  for(var i=1;i<=nPages;i++){
    var w=document.createElement('div');w.className='pg';w.dataset.page=i;
    var c=document.createElement('canvas');canvases[i]=c;wraps[i]=w;
    var d=dims[i],cw=d.w*scale,ch=d.h*scale;
    c.width=1;c.height=1;c.style.width=cw+'px';c.style.height=ch+'px';
    c.style.display='block';c.style.filter='var(--filter)';c.style.borderRadius='2px';
    c.style.background='var(--paper)';
    var hl=document.createElement('div');hl.className='hl-layer';hl.id='hl-'+i;
    var sr=document.createElement('div');sr.className='sr-layer';sr.id='sr-'+i;
    var nm=document.createElement('div');nm.className='pg-n';nm.textContent='\u2014 '+i+' \u2014';
    w.appendChild(c);w.appendChild(hl);w.appendChild(sr);w.appendChild(nm);
    p.appendChild(w);
  }
  var sp=document.createElement('div');sp.className='spacer';p.appendChild(sp);
}

/* ═══ THUMBNAILS ═══ */
function buildThumbs(){
  var list=$('thumbList');list.innerHTML='';
  for(var i=1;i<=nPages;i++)(function(n){
    var row=document.createElement('div');row.className='thumb'+(n===curPg?' cur':'');
    row.dataset.page=n;
    var tc=document.createElement('canvas');
    tc.width=1;tc.height=1;tc.style.width='50px';
    var d=dims[n];tc.style.height=Math.round(50*d.h/d.w)+'px';
    var lbl=document.createElement('span');lbl.className='thumb-n';lbl.textContent='Page '+n;
    row.appendChild(tc);row.appendChild(lbl);
    row.addEventListener('click',function(){goTo(n);closePanel()});
    list.appendChild(row);
    // Render thumb async
    renderThumb(n,tc);
  })(i);
}
function renderThumb(n,tc){
  pdf.getPage(n).then(function(pg){
    var vp=pg.getViewport({scale:.15});
    tc.width=vp.width;tc.height=vp.height;
    tc.style.width='50px';tc.style.height=Math.round(50*vp.height/vp.width)+'px';
    pg.render({canvasContext:tc.getContext('2d'),viewport:vp});
  });
}

/* ═══ LAZY RENDER ═══ */
function renderVis(){
  if(!pdf)return;
  var r=$('pages').getBoundingClientRect(),buf=r.height*1.2;
  for(var i=1;i<=nPages;i++){
    if(rendered[i]||renderQ[i])continue;
    var w=wraps[i];if(!w)continue;
    var wr=w.getBoundingClientRect();
    if(wr.bottom>=r.top-buf&&wr.top<=r.bottom+buf){renderQ[i]=true;renderPg(i)}
  }
}
$('pages').addEventListener('scroll',function(){
  if(viewMode==='scroll'){
    var b=$('pages').getBoundingClientRect(),mid=b.top+b.height/2;
    for(var i=1;i<=nPages;i++){
      var c=canvases[i];if(!c)continue;
      var cr=c.getBoundingClientRect();
      if(cr.top<=mid&&cr.bottom>=mid){if(curPg!==i){curPg=i;updatePg();updateThumbCur()}break}
    }
  }
  if(renderT)clearTimeout(renderT);
  renderT=setTimeout(renderVis,60);
},{passive:true});

function renderPg(n){
  return pdf.getPage(n).then(function(pg){
    var vp=pg.getViewport({scale:scale*DPR});
    var c=canvases[n];if(!c)return;
    var ctx=c.getContext('2d');c.width=vp.width;c.height=vp.height;
    c.style.width=(vp.width/DPR)+'px';c.style.height=(vp.height/DPR)+'px';c.style.background='';
    return pg.render({canvasContext:ctx,viewport:vp}).promise
      .then(function(){return pg.getAnnotations()})
      .then(function(anns){
        var arr=[];
        for(var a=0;a<anns.length;a++){
          var an=anns[a];
          if(an.subtype==='Highlight'||an.subtype==='Underline'||an.subtype==='StrikeOut'){
            var cl=null;
            if(an.color&&an.color.length>=3)cl='rgba('+an.color[0]+','+an.color[1]+','+an.color[2]+',0.38)';
            arr.push({type:an.subtype,rect:an.rect,color:cl,contents:an.contents||''});
          }
        }
        hlStore[n]=arr;
        return pg.getViewport({scale:1});
      }).then(function(pv){
        paintHL(n,pv);rendered[n]=true;delete renderQ[n];
        return pdf.getPage(n);
      }).then(function(pg2){return pg2.getTextContent()})
      .then(function(tc){texts[n]=tc;if(srRes.length)paintSR(n)});
  })['catch'](function(e){console.warn('Pg'+n,e);delete renderQ[n]});
}

/* ═══ HIGHLIGHTS ═══ */
function paintHL(n,pv){
  var ly=document.getElementById('hl-'+n);if(!ly)return;ly.innerHTML='';
  var c=canvases[n],dw=parseFloat(c.style.width),dh=parseFloat(c.style.height);
  var sx=dw/pv.width,sy=dh/pv.height;
  // PDF annotations
  var arr=hlStore[n]||[];
  arr.forEach(function(h){
    var r=h.rect,d=document.createElement('div');d.className='hl-rect';
    d.style.left=(r[0]*sx)+'px';d.style.top=(dh-r[3]*sy)+'px';
    d.style.width=((r[2]-r[0])*sx)+'px';d.style.height=((r[3]-r[1])*sy)+'px';
    d.style.backgroundColor=h.color||'var(--highlight)';
    if(h.contents)d.title=h.contents;ly.appendChild(d);
  });
  // User highlights
  userHL.filter(function(u){return u.page===n}).forEach(function(u){
    var d=document.createElement('div');d.className='hl-rect';
    d.style.left=(u.rect[0]*sx)+'px';d.style.top=(dh-u.rect[3]*sy)+'px';
    d.style.width=((u.rect[2]-u.rect[0])*sx)+'px';d.style.height=((u.rect[3]-u.rect[1])*sy)+'px';
    d.style.backgroundColor='var(--highlight)';ly.appendChild(d);
  });
}
function updateHl(){
  var n=0;for(var k in hlStore)n+=hlStore[k].length;n+=userHL.length;
  $('hlCount').textContent=n>0?n+' hl':'';
}

/* ═══ SEARCH ═══ */
$('btnSearch').addEventListener('click',toggleSrch);
$('srchClose').addEventListener('click',closeSrch);
$('srchNext').addEventListener('click',function(){navSr(1)});
$('srchPrev').addEventListener('click',function(){navSr(-1)});
$('srchIn').addEventListener('input',debounce(doSearch,250));
$('srchIn').addEventListener('keydown',function(e){
  if(e.key==='Enter'){e.preventDefault();navSr(e.shiftKey?-1:1)}
  if(e.key==='Escape')closeSrch();
});
function toggleSrch(){$('searchBar').classList.toggle('open');if($('searchBar').classList.contains('open'))$('srchIn').focus();else clearSr()}
function closeSrch(){$('searchBar').classList.remove('open');clearSr()}
function clearSr(){srRes=[];srIdx=-1;$('srchInfo').textContent='';$('srchIn').value='';
  for(var i=1;i<=nPages;i++){var s=document.getElementById('sr-'+i);if(s)s.innerHTML=''}}
function debounce(fn,ms){var t;return function(){clearTimeout(t);var a=arguments,c=this;t=setTimeout(function(){fn.apply(c,a)},ms)}}
function doSearch(){
  var q=$('srchIn').value.trim().toLowerCase();
  srRes=[];srIdx=-1;
  for(var i=1;i<=nPages;i++){var s=document.getElementById('sr-'+i);if(s)s.innerHTML=''}
  if(!q){$('srchInfo').textContent='';return}
  // Extract text from unvisited pages first
  var chain=Promise.resolve();
  for(var p=1;p<=nPages;p++)(function(n){
    if(!texts[n]) chain=chain.then(function(){
      return pdf.getPage(n).then(function(pg){return pg.getTextContent()}).then(function(tc){texts[n]=tc});
    });
  })(p);
  chain.then(function(){
    for(var n=1;n<=nPages;n++){
      var tc=texts[n];if(!tc)continue;
      for(var j=0;j<tc.items.length;j++){
        var it=tc.items[j],txt=it.str.toLowerCase(),idx=0;
        while((idx=txt.indexOf(q,idx))!==-1){
          srRes.push({page:n,item:it,idx:idx,len:q.length});idx+=q.length;
        }
      }
    }
    $('srchInfo').textContent=srRes.length?srRes.length+' found':'None';
    if(srRes.length){srIdx=0;showSrHit()}
    for(var n2=1;n2<=nPages;n2++)paintSR(n2);
  });
}
function paintSR(n){
  var sl=document.getElementById('sr-'+n);if(!sl)return;sl.innerHTML='';
  var hits=srRes.filter(function(r){return r.page===n});if(!hits.length)return;
  var d=dims[n];if(!d)return;
  var c=canvases[n],dw=parseFloat(c.style.width),dh=parseFloat(c.style.height);
  var sx=dw/d.w,sy=dh/d.h;
  hits.forEach(function(h){
    var it=h.item,tx=it.transform;
    var el=document.createElement('div');el.className='sr-rect';
    var gi=srRes.indexOf(h);if(gi===srIdx)el.classList.add('cur');
    el.style.left=(tx[4]*sx)+'px';el.style.top=(dh-tx[5]*sy-it.height*sy)+'px';
    el.style.width=(it.width*sx)+'px';el.style.height=(it.height*sy)+'px';
    sl.appendChild(el);
  });
}
function navSr(dir){if(!srRes.length)return;srIdx=(srIdx+dir+srRes.length)%srRes.length;showSrHit();
  for(var p=1;p<=nPages;p++)paintSR(p)}
function showSrHit(){if(srIdx<0)return;var h=srRes[srIdx];
  $('srchInfo').textContent=(srIdx+1)+'/'+srRes.length;
  curPg=h.page;updatePg();
  if(viewMode==='single')applyVM();
  if(!rendered[h.page])renderPg(h.page).then(function(){scrollPg(h.page)});
  else scrollPg(h.page);
}
function scrollPg(n){var w=wraps[n];if(w)w.scrollIntoView({behavior:'smooth',block:'center'})}

/* ═══ SELECTION POPUP — highlight + define ═══ */
var selPopup=$('selPopup');
document.addEventListener('selectionchange',function(){
  var sel=window.getSelection();
  if(!sel||sel.isCollapsed||!sel.toString().trim()){selPopup.classList.remove('show');return}
  var range=sel.getRangeAt(0);var rect=range.getBoundingClientRect();
  if(!rect.width){selPopup.classList.remove('show');return}
  selPopup.style.left=Math.max(4,rect.left+rect.width/2-80)+'px';
  selPopup.style.top=Math.max(4,rect.top-44)+'px';
  selPopup.classList.add('show');
});

$('selDef').addEventListener('click',function(){
  var t=window.getSelection().toString().trim();
  if(t) window.open('https://www.google.com/search?q=define+'+encodeURIComponent(t),'_blank');
  selPopup.classList.remove('show');
});
$('selCopy').addEventListener('click',function(){
  var t=window.getSelection().toString();
  navigator.clipboard.writeText(t)['catch'](function(){});
  selPopup.classList.remove('show');
});
$('selHL').addEventListener('click',function(){
  // For now store a simple highlight record
  selPopup.classList.remove('show');
  window.getSelection().removeAllRanges();
});

/* ═══ NAV / ZOOM ═══ */
$('btnPrev').addEventListener('click',function(){goTo(curPg-1)});
$('btnNext').addEventListener('click',function(){goTo(curPg+1)});
function goTo(n){n=Math.max(1,Math.min(n,nPages));curPg=n;updatePg();updateThumbCur();
  if(viewMode==='scroll')scrollPg(n);else applyVM();setTimeout(renderVis,80)}
function updatePg(){$('pgLabel').textContent=curPg+' / '+nPages;
  $('btnPrev').disabled=curPg<=1;$('btnNext').disabled=curPg>=nPages}
function updateThumbCur(){
  var ts=$('thumbList').querySelectorAll('.thumb');
  for(var i=0;i<ts.length;i++) ts[i].classList.toggle('cur',parseInt(ts[i].dataset.page)===curPg);
}

$('btnZI').addEventListener('click',function(){doZoom(Math.min(3,+(scale+.15).toFixed(2)))});
$('btnZO').addEventListener('click',function(){doZoom(Math.max(.4,+(scale-.15).toFixed(2)))});
function doZoom(s){
  scale=s;updateZoom();rendered={};renderQ={};
  for(var i=1;i<=nPages;i++){
    var d=dims[i];if(!d)continue;var c=canvases[i];
    c.style.width=(d.w*scale)+'px';c.style.height=(d.h*scale)+'px';
    var hl=document.getElementById('hl-'+i);if(hl)hl.innerHTML='';
    var sr=document.getElementById('sr-'+i);if(sr)sr.innerHTML='';
  }
  setTimeout(renderVis,50);
}
function updateZoom(){$('zoomLbl').textContent=Math.round(scale*100)+'%'}

/* ═══ VIEW MODE ═══ */
$('vScroll').addEventListener('click',function(){setVM('scroll')});
$('vSingle').addEventListener('click',function(){setVM('single')});
function setVM(m){viewMode=m;
  $('vScroll').classList.toggle('on',m==='scroll');
  $('vSingle').classList.toggle('on',m==='single');
  applyVM();setTimeout(renderVis,80);
}
function applyVM(){
  var p=$('pages');p.classList.toggle('single',viewMode==='single');
  var ws=p.querySelectorAll('.pg');
  for(var i=0;i<ws.length;i++){
    var pn=parseInt(ws[i].dataset.page);
    ws[i].style.display=(viewMode==='single'&&pn!==curPg)?'none':'';
  }
  var sp=p.querySelector('.spacer');if(sp)sp.style.display=(viewMode==='scroll')?'':'none';
}

/* ═══ PANELS ═══ */
$('btnThumbs').addEventListener('click',function(){openPanel('thumbPanel')});
$('thumbClose').addEventListener('click',closePanel);
$('btnSettings').addEventListener('click',function(){openPanel('settPanel')});
$('settClose').addEventListener('click',closePanel);
$('backdrop').addEventListener('click',closePanel);
function openPanel(id){
  closePanel();$(id).classList.add('open');$('backdrop').classList.add('show');
}
function closePanel(){
  $('thumbPanel').classList.remove('open');$('settPanel').classList.remove('open');
  $('backdrop').classList.remove('show');
}

/* ═══ FULLSCREEN ═══ */
$('btnFS').addEventListener('click',function(){
  var d=document.documentElement;
  if(!document.fullscreenElement&&!document.webkitFullscreenElement){
    if(d.requestFullscreen)d.requestFullscreen();
    else if(d.webkitRequestFullscreen)d.webkitRequestFullscreen();
  }else{
    if(document.exitFullscreen)document.exitFullscreen();
    else if(document.webkitExitFullscreen)document.webkitExitFullscreen();
  }
});

/* ═══ BARS TOGGLE ═══ */
$('togBars').addEventListener('click',function(){
  barsVis=!barsVis;
  $('topbar').classList.toggle('hide',!barsVis);
  $('botbar').classList.toggle('hide',!barsVis);
  $('togBars').textContent=barsVis?'\u25B6':'\u25C0';
});

/* ═══ BACK ═══ */
$('btnBack').addEventListener('click',function(){
  pdf=null;nPages=0;hlStore={};canvases={};wraps={};rendered={};dims={};texts={};
  $('pages').innerHTML='';$('fileInput').value='';$('thumbList').innerHTML='';
  srRes=[];srIdx=-1;userHL=[];closePanel();closeSrch();showSplash();
});

/* ═══ KEYBOARD ═══ */
document.addEventListener('keydown',function(e){
  if(!pdf)return;if(e.target.tagName==='INPUT')return;
  switch(e.key){
    case'ArrowLeft':case'ArrowUp':goTo(curPg-1);break;
    case'ArrowRight':case'ArrowDown':goTo(curPg+1);break;
    case'+':case'=':doZoom(Math.min(3,+(scale+.15).toFixed(2)));break;
    case'-':doZoom(Math.max(.4,+(scale-.15).toFixed(2)));break;
    case'f':case'F':if(e.ctrlKey||e.metaKey){e.preventDefault();toggleSrch()}break;
  }
});

/* ═══ INIT ═══ */
refreshLibrary();

})();
</script>
<script>if('serviceWorker' in navigator)navigator.serviceWorker.register('./sw.js')['catch'](function(){});</script>
</body>
</html>
